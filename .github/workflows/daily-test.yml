name: Daily Speedtest

# 触发条件：每天北京时间早上 6 点运行 (UTC 22:00)
on:
  schedule:
    - cron: '0 22 * * *'
  workflow_dispatch: # 允许你手动点击按钮运行

jobs:
  speedtest:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Download CloudflareST
        run: |
          # 下载最新的 Linux 版本测速工具
          wget -N https://github.com/XIU2/CloudflareSpeedTest/releases/download/v2.2.5/CloudflareSpeedTest_linux_amd64.tar.gz
          tar -zxf CloudflareSpeedTest_linux_amd64.tar.gz
          chmod +x CloudflareST

      - name: Run Speedtest
        run: |
          # 运行测速：下载 200MB 测试，延迟 200ms 以内，取最快的前 10 个
          # 结果输出到 result.csv
          ./CloudflareST -tp 443 -url https://speed.cloudflare.com/__down?bytes=200000000 -tl 200 -dn 10 -o result.csv

      - name: Extract Best IPs
        run: |
          # 从 CSV 提取 IP 地址列，保存到 ip.txt
          awk -F, 'NR>1 {print $1}' result.csv > ip.txt
          # 看看提取了啥（打印到日志）
          cat ip.txt

      - name: Commit and Push
        run: |
          # 配置 Git 身份
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # 提交 ip.txt 到仓库
          git add ip.txt
          git commit -m "Update best IPs" || exit 0
          git push
